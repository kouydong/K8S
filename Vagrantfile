#=============================================================================
# 작성자  : kouydong
# 작성일  : Apr 24th 2022
# 작성내용 : Vagrant를 통해 Oracle Virtual Box에 4개 노드 생성 스크립트(Ruby)
#=============================================================================
# Vagramt 시작을 알리는 문장
Vagrant.configure("2") do |config|


  #=============================================================================
  # 메인노드 설정 START
  #-----------------------------------------------------------------------------
  config.vm.define "m-k8s" do |cfg|    
    #-----------------------------------------------------------------------------
    cfg.vm.box      = "sysnet4admin/CentOS-k8s"               # 가상머신 선택 Vagrant Cloud 주소 : https://vagrantcloud.com/search
    cfg.vm.host_name= "m-k8s"                                 # 호스트이름설정
    cfg.vm.network    "private_network", ip:"192.168.1.10"    # 가상머신 네트워크 설정        
    cfg.vm.synced_folder "../data", "/vagrant", disabled:true # 호스트(PC 또는 노트북)와 게스트(가상머신) 사이에 디렉터리 동기화가 이루어지지 않게 설정            
    #-----------------------------------------------------------------------------
    # SSH설정 
    #-----------------------------------------------------------------------------
    # 호스트로 접근할 경우 : 60010 사용
    # 게스트로 접근할 경우 : 22 사용
    # 비고                : 포트중복된 경우 자동증가
    #-----------------------------------------------------------------------------
    cfg.vm.network    "forwarded_port", guest: 22, host:60010, auto_correct:true, id:"ssh"                                
    
    
    #=============================================================================
    # Provisioning 설정 START
    #-----------------------------------------------------------------------------    
    # install_pkg.sh 게스트에서 스크립트 실행
    #-----------------------------------------------------------------------------    
    cfg.vm.provision "shell", path: "install_pkg.sh"          
    #-----------------------------------------------------------------------------    
    # 호스트에 있는 ping_2_nds.sh 파일을 게스트의 홈 디렉토리(/home/vagrant)로 전달
    #-----------------------------------------------------------------------------    
    cfg.vm.provision "file" , source: "ping_test.sh", destination: "ping_test.sh" 
    #-----------------------------------------------------------------------------    
    # config.sh 게스트에서 스크립트 실행
    #-----------------------------------------------------------------------------    
    cfg.vm.provision "shell", path: "config.sh" 
    #-----------------------------------------------------------------------------    
    # Provisioning 설정 END
    #=============================================================================    
    
    
    #=============================================================================
    # 가상머신제공자설정START
    #-----------------------------------------------------------------------------
    cfg.vm.provider "virtualbox" do |vb|                                          # 가상머신제공자를virtualbox로설정
      vb.name       = "m-k8s(github_SysNet4Admin)"                                # 가상머신이름
      vb.cpus       = 2                                                           # 가상머신CPU
      vb.memory     = 2048                                                        # 가상머신Memory(2GB)
      vb.customize  ["modifyvm", :id, "--groups", "/k8s-SM(github_SysNet4Admin)"] # 소속된그룹
    end
    #-----------------------------------------------------------------------------
    # 가상머신제공자설정END
    #=============================================================================
  end 
  #-----------------------------------------------------------------------------
  # 메인노드 설정 END
  #=============================================================================


  #=============================================================================
  # 반복문 START
  #-----------------------------------------------------------------------------
  (1..3).each do |i|
    #=============================================================================
    # 서브노드 설정(3개 추가) START 
    #-----------------------------------------------------------------------------
    config.vm.define "w#{i}-k8s" do |cfg|
      cfg.vm.box      = "sysnet4admin/CentOS-k8s"               # 가상머신 선택 Vagrant Cloud 주소 : https://vagrantcloud.com/search
      cfg.vm.host_name= "m-k8s"                                 # 호스트이름설정
      cfg.vm.network    "private_network", ip:"192.168.1.10#{i}"# 가상머신 네트워크 설정(192.168.1.101~103)
      cfg.vm.synced_folder "../data", "/vagrant", disabled:true # 호스트(PC 또는 노트북)와 게스트(가상머신) 사이에 디렉터리 동기화가 이루어지지 않게 설정            
      #-----------------------------------------------------------------------------
      # SSH설정 
      #-----------------------------------------------------------------------------
      # 호스트로 접근할 경우 : 60101 ~ 60103 사용
      # 게스트로 접근할 경우 : 22 사용
      # 비고                : 포트중복된 경우 자동증가
      #-----------------------------------------------------------------------------
      cfg.vm.network    "forwarded_port", guest: 22, host:"6010#{i}", auto_correct:true, id:"ssh"
      
      
      #=============================================================================
      # Provisioning 설정 START
      #-----------------------------------------------------------------------------    
      # install_pkg.sh 게스트에서 스크립트 실행
      #-----------------------------------------------------------------------------    
      cfg.vm.provision "shell", path: "install_pkg.sh"                
      #-----------------------------------------------------------------------------    
      # Provisioning 설정 END
      #============================================================================= 


      #=============================================================================
      # 가상머신제공자설정START
      #-----------------------------------------------------------------------------
      cfg.vm.provider "virtualbox" do |vb|                                          # 가상머신제공자를virtualbox로설정
        vb.name       = "w#{i}-k8s(github_SysNet4Admin)"                            # 가상머신이름(w1-k8s, w2-k8s, w3-k8s)
        vb.cpus       = 1                                                           # 가상머신CPU
        vb.memory     = 1024                                                        # 가상머신Memory(1GB)
        vb.customize  ["modifyvm", :id, "--groups", "/k8s-SM(github_SysNet4Admin)"] # 소속된그룹
      end
      #-----------------------------------------------------------------------------
      # 가상머신제공자설정END
      #=============================================================================
    end
    #-----------------------------------------------------------------------------
    # 서브노드 설정(3개 추가) END
    #=============================================================================
  end
  #-----------------------------------------------------------------------------
  # 반복문 END
  #=============================================================================


end